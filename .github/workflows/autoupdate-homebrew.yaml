name: Update Homebrew Version

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-homebrew:
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Check for updates
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_VERSION=$(perl -nle 'print $1 if /github:Homebrew\/brew\/([0-9.]+)/' flake.nix)
          echo "Current version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          LATEST_VERSION=$(gh api repos/Homebrew/brew/releases/latest --jq .tag_name)
          echo "Latest version raw: $LATEST_VERSION"

          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
            echo "Error: Failed to fetch latest version from GitHub API."
            gh api repos/Homebrew/brew/releases/latest || true
            exit 1
          fi

          if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
            echo "Already up to date."
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            echo "New version detected: $LATEST_VERSION"
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Update Flake and Files
        if: steps.check.outputs.updated == 'true'
        run: |
          NEW_VERSION="${{ steps.check.outputs.latest_version }}"
          
          perl -pi -e "s|github:Homebrew/brew/[0-9.]+|github:Homebrew/brew/$NEW_VERSION|" flake.nix
          
          nix flake lock --update-input brew-src
          
          nix develop --command bash scripts/update-brew-tail.sh

      - name: Create Pull Request
        if: steps.check.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "brew-src: ${{ steps.check.outputs.current_version }} -> ${{ steps.check.outputs.latest_version }}"
          branch: "update-homebrew-${{ steps.check.outputs.latest_version }}"
          delete-branch: true
          title: "brew-src: ${{ steps.check.outputs.current_version }} -> ${{ steps.check.outputs.latest_version }}"
          body: |
            Automated update of Homebrew version.
            
            - **Current Version**: `${{ steps.check.outputs.current_version }}`
            - **New Version**: `${{ steps.check.outputs.latest_version }}`
            
            Auto-generated by `autoupdate-homebrew.yaml` workflow.
          labels: |
            dependencies
            automated
